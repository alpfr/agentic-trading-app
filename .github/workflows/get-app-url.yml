name: Get App URL

on:
  workflow_dispatch:

jobs:
  get-url:
    name: Get Live App URL
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            us-east-1

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "v1.29.0"

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name agentic-trading-cluster --region us-east-1

      - name: Get App URL
        run: |
          echo "=== Ingress ==="
          kubectl get ingress agentic-trading-ingress -n agentic-trading-platform

          ALB=$(kubectl get ingress agentic-trading-ingress \
            -n agentic-trading-platform \
            -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')

          echo ""
          echo "=== Pods ==="
          kubectl get pods -n agentic-trading-platform

          echo ""
          echo "=== Health Check ==="
          sleep 3
          curl -s -o /dev/null -w "HTTP Status: %{http_code}" http://$ALB/health || echo "Health check pending"

          echo ""
          echo "### ðŸš€ Your App is Live!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **App** | http://$ALB |" >> $GITHUB_STEP_SUMMARY
          echo "| **API** | http://$ALB/api |" >> $GITHUB_STEP_SUMMARY
          echo "| **Health** | http://$ALB/health |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Open the App URL in your browser to access the trading dashboard." >> $GITHUB_STEP_SUMMARY

          echo ""
          echo "================================================"
          echo "  APP URL: http://$ALB"
          echo "================================================"
